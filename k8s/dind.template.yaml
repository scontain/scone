apiVersion: apps/v1
kind: Deployment
metadata: {name: dind, namespace: $CLI_NAMESPACE}
spec:
  replicas: 1
  selector: {matchLabels: {app: dind}}
  template:
    metadata: {labels: {app: dind}}
    spec:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        fsGroupChangePolicy: "OnRootMismatch"
      containers:
      - name: dind
        image: docker:dind-rootless
        securityContext:
          allowPrivilegeEscalation: true
          readOnlyRootFilesystem: false        # Docker needs writable state
          capabilities:
            drop: ["ALL"]
          seccompProfile:
            type: Unconfined                   # FUSE often needs this
        volumeMounts:
          - name: docker-data
            mountPath: /home/rootless/.local/share/docker
          - name: xdg
            mountPath: /run/user/1000
          - name: dev-fuse
            mountPath: /dev/fuse
        volumeDevices: []                      # keep empty; we use volumeMount above
        imagePullPolicy: Always
        env:
        - name: DOCKER_TLS_CERTDIR
          value: ""                     # <â€” disable TLS
        args: ["--host=tcp://0.0.0.0:2375","--host=unix:///var/run/docker.sock","--storage-driver=overlay2"]
        ports: [{containerPort: 2375, name: docker}]
        volumeMounts:
        - {name: dind-lib, mountPath: /var/lib/docker}
      volumes:
      - name: dind-lib
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata: {name: dind, namespace: $CLI_NAMESPACE}
spec:
  selector: {app: dind}
  ports: [{name: docker, port: 2375, targetPort: 2375}]
